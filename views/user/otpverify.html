<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - neXora</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-md">
            <!-- Header -->
            <div class="text-center">
                <h2 class="text-3xl font-extrabold text-gray-900">Reset Password</h2>
                <p class="mt-2 text-sm text-gray-600">
                    Enter the OTP sent to your email and create a new password
                </p>
            </div>

            <!-- Form -->
            <form class="mt-8 space-y-6" id="resetForm">
                <!-- OTP Input -->
                <div class="space-y-2">
                    <label for="otp" class="block text-sm font-medium text-gray-700">
                        Enter OTP
                    </label>
                    <div class="flex justify-between gap-2">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                        <input type="text" maxlength="1" class="otp-input h-12 w-12 text-center text-xl border-2 rounded bg-white focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <p class="mt-1 text-sm text-gray-500" id="otpTimer">
                        Time remaining: <span class="font-medium">05:00</span>
                    </p>
                    <button type="button" id="resendOtp" class="text-indigo-600 text-sm font-medium hover:text-indigo-500 disabled:text-gray-400" disabled>
                        Resend OTP
                    </button>
                </div>

                <!-- New Password -->
                <div class="space-y-2">
                    <label for="password" class="block text-sm font-medium text-gray-700">
                        New Password
                    </label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required 
                            class="appearance-none relative block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Enter new password">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-500" id="togglePassword">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Password Requirements -->
                    <div class="text-xs space-y-1 text-gray-600">
                        <p class="requirement" data-requirement="length">
                            <span class="inline-block w-4 h-4 mr-1 border border-gray-300 rounded-full"></span>
                            At least 8 characters
                        </p>
                        <p class="requirement" data-requirement="uppercase">
                            <span class="inline-block w-4 h-4 mr-1 border border-gray-300 rounded-full"></span>
                            One uppercase letter
                        </p>
                        <p class="requirement" data-requirement="number">
                            <span class="inline-block w-4 h-4 mr-1 border border-gray-300 rounded-full"></span>
                            One number
                        </p>
                        <p class="requirement" data-requirement="special">
                            <span class="inline-block w-4 h-4 mr-1 border border-gray-300 rounded-full"></span>
                            One special character
                        </p>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div class="space-y-2">
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700">
                        Confirm Password
                    </label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" name="confirmPassword" required
                            class="appearance-none relative block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Confirm new password">
                    </div>
                    <p class="text-sm text-red-500 hidden" id="passwordMatch">Passwords do not match</p>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" id="submitBtn"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Reset Password
                    </button>
                </div>

                <!-- Error Message -->
                <div class="text-red-500 text-sm text-center hidden" id="errorMessage"></div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // OTP Input Handling
            const otpInputs = document.querySelectorAll('.otp-input');
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value) {
                        input.value = e.target.value[0];
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            // Password Toggle
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            togglePassword.addEventListener('click', () => {
                const type = passwordInput.type === 'password' ? 'text' : 'password';
                passwordInput.type = type;
            });

            // Password Validation
            const password = document.getElementById('password');
            const confirmPassword = document.getElementById('confirmPassword');
            const requirements = document.querySelectorAll('.requirement');
            const passwordMatch = document.getElementById('passwordMatch');

            function validatePassword(value) {
                const conditions = {
                    length: value.length >= 8,
                    uppercase: /[A-Z]/.test(value),
                    number: /[0-9]/.test(value),
                    special: /[!@#$%^&*]/.test(value)
                };

                requirements.forEach(req => {
                    const type = req.dataset.requirement;
                    const dot = req.querySelector('span');
                    if (conditions[type]) {
                        dot.classList.add('bg-green-500');
                        dot.classList.remove('border-gray-300');
                    } else {
                        dot.classList.remove('bg-green-500');
                        dot.classList.add('border-gray-300');
                    }
                });

                return Object.values(conditions).every(Boolean);
            }

            // Password Match Validation
            function checkPasswordMatch() {
                const match = password.value === confirmPassword.value;
                passwordMatch.classList.toggle('hidden', match);
                return match;
            }

            password.addEventListener('input', () => validatePassword(password.value));
            confirmPassword.addEventListener('input', checkPasswordMatch);

            // Timer for OTP
            let timeLeft = 300; // 5 minutes in seconds
            const timerDisplay = document.querySelector('#otpTimer span');
            const resendButton = document.getElementById('resendOtp');

            function updateTimer() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (timeLeft === 0) {
                    resendButton.disabled = false;
                    clearInterval(timer);
                } else {
                    timeLeft--;
                }
            }

            const timer = setInterval(updateTimer, 1000);

            // Form Submission
            const form = document.getElementById('resetForm');
            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validate OTP
                const otp = Array.from(otpInputs).map(input => input.value).join('');
                if (otp.length !== 6) {
                    errorMessage.textContent = 'Please enter the complete OTP';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                // Validate Password
                if (!validatePassword(password.value)) {
                    errorMessage.textContent = 'Please meet all password requirements';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                // Validate Password Match
                if (!checkPasswordMatch()) {
                    errorMessage.textContent = 'Passwords do not match';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Resetting Password...
                    `;

                    // Submit form data
                    const response = await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            otp,
                            password: password.value
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        window.location.href = '/login?reset=success';
                    } else {
                        throw new Error(data.message || 'Failed to reset password');
                    }
                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Reset Password';
                }
            });
        });
    </script>
</body>
</html>